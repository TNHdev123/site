<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>alwaysPWA</title>
    <style>
        :root {
            --bg: #ffffff; --text: #000000; --border: #000000; --accent: #007AFF;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #000000; --text: #ffffff; --border: #ffffff; }
        }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden;
        }
        .view { width: 85%; max-width: 400px; text-align: center; display: none; }
        h1 { font-size: 3rem; font-weight: 900; margin-bottom: 2rem; letter-spacing: -1.5px; }
        input {
            width: 100%; padding: 16px; font-size: 1.1rem; background: transparent;
            color: var(--text); border: 4px solid var(--border); box-sizing: border-box;
            outline: none; font-weight: 700; margin-bottom: 15px;
        }
        button {
            width: 100%; padding: 16px; font-size: 1.2rem; font-weight: 900;
            background-color: var(--accent); color: #fff; border: 4px solid var(--border);
            cursor: pointer;
        }
        .icon-preview {
            width: 120px; height: 120px; border-radius: 26px;
            border: 3px solid var(--border); margin-bottom: 20px;
            object-fit: cover; background: #fff;
        }
        h2 { margin: 0; font-size: 1.8rem; font-weight: 800; }
        .arrow { font-size: 2.5rem; animation: bounce 2s infinite; margin-top: 20px; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        .loader { border: 5px solid var(--border); border-top: 5px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="inputView" class="view">
        <h1>alwaysPWA</h1>
        <input type="url" id="urlInput" placeholder="Enter URL..." autocomplete="off">
        <button id="goBtn">Get PWA!</button>
    </div>

    <div id="loadingView" class="view" style="flex-direction: column; align-items: center;">
        <div class="loader"></div>
        <p>Analyzing Website...</p>
    </div>

    <div id="installView" class="view">
        <img id="finalIcon" class="icon-preview" src="">
        <h2 id="finalName">App</h2>
        <p>1. Tap the <strong>Share</strong> button ↓<br>2. Select <strong>Add to Home Screen</strong></p>
        <div class="arrow">↓</div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const targetSite = params.get('site');

        // 輔助函式
        const resolveUrl = (base, rel) => { try { return new URL(rel, base).href; } catch(e) { return rel; } };
        const cleanTitle = (t) => t ? t.split(/\s[–|—\-]\s/)[0].trim() : "";

        function injectPwaMeta(name, iconUrl) {
            document.title = name;
            // Apple Meta
            let appleTitle = document.querySelector('meta[name="apple-mobile-web-app-title"]') || document.createElement('meta');
            appleTitle.name = "apple-mobile-web-app-title"; appleTitle.content = name; document.head.appendChild(appleTitle);

            let appleIcon = document.querySelector('link[rel="apple-touch-icon"]') || document.createElement('link');
            appleIcon.rel = "apple-touch-icon"; appleIcon.href = iconUrl; document.head.appendChild(appleIcon);

            // Manifest Blob (全螢幕關鍵)
            const manifest = {
                "name": name, "short_name": name, "start_url": window.location.href,
                "display": "standalone", "background_color": "#000000",
                "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/png" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            let mLink = document.querySelector('link[rel="manifest"]') || document.createElement('link');
            mLink.rel = 'manifest'; mLink.href = URL.createObjectURL(blob); document.head.appendChild(mLink);
        }

        if (!targetSite) {
            document.getElementById('inputView').style.display = 'block';
            document.getElementById('goBtn').onclick = () => {
                let url = document.getElementById('urlInput').value.trim();
                if (!url) return;
                if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                window.location.search = `?site=${encodeURIComponent(url)}`;
            };
        } else {
            // PWA 跳轉模式
            if (window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
                window.location.replace(targetSite);
            } else {
                document.getElementById('loadingView').style.display = 'flex';
                
                (async function smartFetch() {
                    let finalName = "";
                    let finalIcon = "";

                    try {
                        // 嘗試抓取 HTML
                        const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(targetSite)}`);
                        const data = await res.json();
                        const doc = new DOMParser().parseFromString(data.contents, 'text/html');

                        // 1. 嘗試 Manifest
                        const mLink = doc.querySelector('link[rel="manifest"]');
                        if (mLink) {
                            try {
                                const mRes = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(resolveUrl(targetSite, mLink.getAttribute('href')))}`);
                                const mData = await mRes.json();
                                const m = JSON.parse(mData.contents);
                                finalName = m.short_name || m.name;
                                if (m.icons) finalIcon = resolveUrl(targetSite, m.icons[m.icons.length-1].src);
                            } catch(e){}
                        }

                        // 2. 嘗試 Apple Touch Icon (優先)
                        if (!finalName) finalName = cleanTitle(doc.title);
                        if (!finalIcon) {
                            const apple = doc.querySelector('link[rel="apple-touch-icon"]') || doc.querySelector('link[rel="apple-touch-icon-precomposed"]');
                            if (apple) finalIcon = resolveUrl(targetSite, apple.getAttribute('href'));
                        }
                    } catch (err) {
                        console.warn("Proxy blocked or failed. Using Fallback Strategy.");
                    }

                    // --- 備援策略 (即使 Fetch 失敗也會執行) ---
                    if (!finalName) {
                        const urlObj = new URL(targetSite);
                        const hostParts = urlObj.hostname.split('.');
                        finalName = hostParts.length > 2 ? hostParts[1] : hostParts[0];
                        finalName = finalName.charAt(0).toUpperCase() + finalName.slice(1);
                    }
                    if (!finalIcon) {
                        // 使用 Google Favicon API 作為最強後備 (256px)
                        finalIcon = `https://www.google.com/s2/favicons?sz=256&domain=${new URL(targetSite).hostname}`;
                    }

                    // 注入並顯示
                    injectPwaMeta(finalName, finalIcon);
                    document.getElementById('finalName').innerText = finalName;
                    document.getElementById('finalIcon').src = finalIcon;
                    document.getElementById('loadingView').style.display = 'none';
                    document.getElementById('installView').style.display = 'block';
                })();
            }
        }
    </script>
</body>
</html>
