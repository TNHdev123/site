<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>alwaysPWA</title>

    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --border: #000000;
            --accent: #007AFF;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --text: #ffffff;
                --border: #ffffff;
            }
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* 主介面與預覽容器 */
        .view {
            display: none;
            width: 90%;
            max-width: 450px;
            text-align: center;
            flex-direction: column;
            align-items: center;
        }

        h1 { font-size: 3.5rem; font-weight: 900; margin-bottom: 2rem; letter-spacing: -1.5px; }
        
        input {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            background: transparent;
            color: var(--text);
            border: 4px solid var(--border);
            box-sizing: border-box;
            outline: none;
            font-weight: 700;
            margin-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 16px;
            font-size: 1.2rem;
            font-weight: 900;
            background-color: var(--accent);
            color: #fff;
            border: 4px solid var(--border);
            cursor: pointer;
        }

        /* 提取後的顯示內容 */
        .icon-preview {
            width: 120px;
            height: 120px;
            border-radius: 24px;
            border: 3px solid var(--border);
            margin-bottom: 20px;
            background: #fff;
        }

        .arrow { font-size: 2.5rem; animation: bounce 2s infinite; margin-top: 20px; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        /* Loader */
        .loader {
            border: 4px solid var(--bg);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="inputView" class="view">
        <h1>alwaysPWA</h1>
        <input type="url" id="urlInput" placeholder="https://example.com" spellcheck="false">
        <button id="goBtn">Get PWA!</button>
    </div>

    <div id="loadingView" class="view">
        <div class="loader"></div>
        <p>Fetching App Assets...</p>
    </div>

    <div id="installView" class="view">
        <img id="finalIcon" class="icon-preview">
        <h2 id="finalName"></h2>
        <p>Ready to install!<br>Tap <strong>Share</strong> and <strong>Add to Home Screen</strong>.</p>
        <div class="arrow">↓</div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const targetSite = params.get('site');

        const inputView = document.getElementById('inputView');
        const loadingView = document.getElementById('loadingView');
        const installView = document.getElementById('installView');

        // 路徑補全工具
        function resolveUrl(base, relative) {
            try { return new URL(relative, base).href; } catch (e) { return relative; }
        }

        // 名稱淨化工具
        function cleanTitle(t) {
            if (!t) return "My PWA";
            return t.split(/\s[–|—\-]\s/)[0].trim();
        }

        // 初始化判斷
        if (!targetSite) {
            inputView.style.display = 'flex';
            document.getElementById('goBtn').onclick = () => {
                let url = document.getElementById('urlInput').value.trim();
                if (!url) return;
                if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                window.location.search = `?site=${encodeURIComponent(url)}`;
            };
        } else {
            // 如果已經是 Standalone 模式開啟，直接跳轉
            if (window.navigator.standalone) {
                window.location.replace(targetSite);
            } else {
                loadingView.style.display = 'flex';
                extractAssets(targetSite);
            }
        }

        async function extractAssets(url) {
            try {
                const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxy);
                const data = await res.json();
                const doc = new DOMParser().parseFromString(data.contents, 'text/html');

                let name = "";
                let icon = "";

                // 1. Manifest 優先
                const manifestLink = doc.querySelector('link[rel="manifest"]');
                if (manifestLink) {
                    try {
                        const mUrl = resolveUrl(url, manifestLink.getAttribute('href'));
                        const mRes = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(mUrl)}`);
                        const mData = await mRes.json();
                        const manifest = JSON.parse(mData.contents);
                        name = manifest.short_name || manifest.name;
                        if (manifest.icons) {
                            const best = manifest.icons.sort((a,b) => (parseInt(b.sizes)-parseInt(a.sizes)))[0];
                            icon = resolveUrl(mUrl, best.src);
                        }
                    } catch(e) {}
                }

                // 2. HTML Fallback
                if (!name) name = cleanTitle(doc.title);
                if (!icon) {
                    const apple = doc.querySelector('link[rel="apple-touch-icon"]') || doc.querySelector('link[rel="apple-touch-icon-precomposed"]');
                    const fav = doc.querySelector('link[rel="icon"][sizes="192x192"]') || doc.querySelector('link[rel="icon"]');
                    icon = apple ? resolveUrl(url, apple.getAttribute('href')) : 
                           (fav ? resolveUrl(url, fav.getAttribute('href')) : resolveUrl(url, '/favicon.ico'));
                }

                // --- 重要：在顯示介面前，動態注入 Meta 標籤 ---
                // 這樣 iOS 讀取到這個狀態時，才會認為這是一個完整的 PWA
                document.title = name;
                
                let link = document.createElement('link');
                link.rel = 'apple-touch-icon';
                link.href = icon;
                document.head.appendChild(link);

                // 更新 UI
                document.getElementById('finalName').innerText = name;
                document.getElementById('finalIcon').src = icon;

                // 切換顯示：隱藏 Loading，顯示 Install
                loadingView.style.display = 'none';
                installView.style.display = 'flex';

            } catch (err) {
                loadingView.innerHTML = `<p>Failed to load. <a href="?" style="color:var(--accent)">Go Back</a></p>`;
            }
        }
    </script>
</body>
</html>
