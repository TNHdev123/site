<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>alwaysPWA</title>
    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --border: #000000;
            --accent: #007AFF;
            --input-bg: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --text: #ffffff;
                --border: #ffffff;
                --input-bg: #000000;
            }
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* 主頁 UI */
        .main-container {
            width: 85%;
            max-width: 400px;
            text-align: center;
            display: none;
        }

        h1 { font-size: 3rem; font-weight: 900; margin-bottom: 2rem; letter-spacing: -1.5px; }

        input {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            background: var(--input-bg);
            color: var(--text);
            border: 4px solid var(--border);
            box-sizing: border-box;
            outline: none;
            font-weight: 700;
            margin-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 16px;
            font-size: 1.2rem;
            font-weight: 900;
            background-color: var(--accent);
            color: #ffffff;
            border: 4px solid var(--border);
            cursor: pointer;
        }

        /* 提取頁 UI */
        .preview-container {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 85%;
        }

        .icon-preview {
            width: 120px;
            height: 120px;
            border-radius: 24px;
            border: 3px solid var(--border);
            margin-bottom: 20px;
            object-fit: cover;
            background-color: #eee;
        }

        h2 { margin: 0; font-size: 1.6rem; font-weight: 800; }
        p { opacity: 0.7; font-size: 0.95rem; margin-top: 10px; line-height: 1.4; }
        
        .arrow { font-size: 2rem; animation: bounce 2s infinite; margin-top: 15px; }

        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        .loader { border: 5px solid var(--border); border-top: 5px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-container" id="inputView">
        <h1>alwaysPWA</h1>
        <input type="url" id="urlInput" placeholder="https://example.com" autocomplete="off">
        <button id="goBtn">Get PWA!</button>
    </div>

    <div class="preview-container" id="loadingView">
        <div class="loader"></div>
        <p>Syncing assets...</p>
    </div>

    <div class="preview-container" id="installView">
        <img id="finalIcon" class="icon-preview" src="">
        <h2 id="finalName">App</h2>
        <p>1. Tap the <strong>Share</strong> button <br>2. Select <strong>Add to Home Screen</strong></p>
        <div class="arrow">↓</div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const targetSite = params.get('site');
        const inputView = document.getElementById('inputView');
        const loadingView = document.getElementById('loadingView');
        const installView = document.getElementById('installView');

        function resolveUrl(base, relative) {
            try { return new URL(relative, base).href; } catch (e) { return relative; }
        }

        function cleanTitle(t) {
            if (!t) return "My PWA";
            return t.split(/\s[–|—\-]\s/)[0].trim();
        }

        // 生成動態 Manifest 確保全螢幕模式
        function injectManifest(name, iconUrl) {
            const manifest = {
                "name": name,
                "short_name": name,
                "start_url": window.location.href,
                "display": "standalone",
                "background_color": "#000000",
                "theme_color": "#000000",
                "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/png" }]
            };
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            
            let link = document.querySelector('link[rel="manifest"]');
            if (!link) {
                link = document.createElement('link');
                link.rel = 'manifest';
                document.head.appendChild(link);
            }
            link.href = manifestURL;
        }

        if (!targetSite) {
            inputView.style.display = 'block';
            document.getElementById('goBtn').onclick = () => {
                let url = document.getElementById('urlInput').value.trim();
                if (!url) return;
                if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                window.location.search = `?site=${encodeURIComponent(url)}`;
            };
        } else {
            // 檢查是否已經是以獨立模式（PWA）開啟
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                window.location.replace(targetSite);
            } else {
                loadingView.style.display = 'flex';
                
                (async function init() {
                    try {
                        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetSite)}`;
                        const res = await fetch(proxyUrl);
                        const data = await res.json();
                        const doc = new DOMParser().parseFromString(data.contents, 'text/html');

                        let pwaName = "";
                        let pwaIcon = "";

                        // 1. Manifest 優先
                        const mLink = doc.querySelector('link[rel="manifest"]');
                        if (mLink) {
                            try {
                                const mRes = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(resolveUrl(targetSite, mLink.getAttribute('href')))}`);
                                const mData = await mRes.json();
                                const m = JSON.parse(mData.contents);
                                pwaName = m.short_name || m.name;
                                if (m.icons) pwaIcon = resolveUrl(targetSite, m.icons[m.icons.length-1].src);
                            } catch(e){}
                        }

                        // 2. HTML 備援
                        if (!pwaName) pwaName = cleanTitle(doc.title);
                        if (!pwaIcon) {
                            const apple = doc.querySelector('link[rel="apple-touch-icon"]');
                            pwaIcon = apple ? resolveUrl(targetSite, apple.getAttribute('href')) : resolveUrl(targetSite, "/favicon.ico");
                        }

                        // --- 重要：更新 Head 標籤，讓 iOS 讀取 ---
                        document.title = pwaName;
                        
                        // 更新 Apple Touch Icon
                        let appleLink = document.querySelector('link[rel="apple-touch-icon"]');
                        if (!appleLink) {
                            appleLink = document.createElement('link');
                            appleLink.rel = 'apple-touch-icon';
                            document.head.appendChild(appleLink);
                        }
                        appleLink.href = pwaIcon;

                        // 更新 PWA 名稱
                        let metaTitle = document.querySelector('meta[name="apple-mobile-web-app-title"]');
                        if (!metaTitle) {
                            metaTitle = document.createElement('meta');
                            metaTitle.name = "apple-mobile-web-app-title";
                            document.head.appendChild(metaTitle);
                        }
                        metaTitle.content = pwaName;

                        // 注入動態 Manifest
                        injectManifest(pwaName, pwaIcon);

                        // 更新 UI
                        document.getElementById('finalName').innerText = pwaName;
                        document.getElementById('finalIcon').src = pwaIcon;
                        
                        // 確保內容都載入後，隱藏 Loading 並顯示安裝介面
                        loadingView.style.display = 'none';
                        installView.style.display = 'flex';

                    } catch (err) {
                        loadingView.innerHTML = `<p>Fetch failed.</p><button onclick="window.location.search=''">Back</button>`;
                    }
                })();
            }
        }
    </script>
</body>
</html>
