<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <title>alwaysPWA</title>
    <link id="dynamic-icon" rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">

    <style>
        /* CSS Variables based on your design */
        :root {
            --primary-blue: #3b82f6; /* Matching the blue in your image */
            --border-color: #000000;
            --border-width: 5px; /* Thick border */
            --bg-color: #ffffff;
            --text-color: #000000;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- Typography --- */
        h1 {
            font-size: 42px;
            font-weight: 800;
            margin-top: 60px;
            margin-bottom: 0;
            text-align: center;
        }

        .subtitle {
            font-size: 16px;
            margin-top: 60px; /* Spacing from title */
            margin-bottom: 10px;
            text-align: center;
            font-weight: 400;
        }

        .preview-text-bottom {
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
        }

        /* --- Components --- */
        
        /* The Input Box */
        .input-box {
            width: 80%;
            max-width: 350px;
            border: var(--border-width) solid var(--border-color);
            padding: 15px;
            font-size: 18px;
            text-align: center;
            outline: none;
            color: #888; /* Placeholder color style */
        }
        .input-box:focus, .input-box:not(:placeholder-shown) {
            color: #000;
        }

        /* The Image Preview Box */
        .image-preview-box {
            width: 200px;
            height: 180px; /* Rectangular aspect from image */
            border: var(--border-width) solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            background: #fff;
        }

        .image-preview-box img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            display: none; /* Hidden until loaded */
        }
        
        .placeholder-text {
            padding: 10px;
            font-size: 14px;
            text-align: center;
            line-height: 1.4;
        }

        /* The Blue Button */
        .btn-blue {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 0;
            font-size: 20px;
            font-weight: 700;
            width: 180px;
            text-align: center;
            cursor: pointer;
            margin-top: 60px; /* Spacing from input/preview */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-blue:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* --- Views Logic --- */
        .view-section {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .visible {
            display: flex;
        }

        /* PWA Fullscreen Iframe */
        #pwa-frame {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            border: none; z-index: 9999; display: none; background: #fff;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-blue);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="view-home" class="view-section">
        <h1>alwaysPWA</h1>
        
        <div class="subtitle">Enter URL to get a PWA</div>
        
        <input type="text" id="url-input" class="input-box" placeholder="http://example.com" autocomplete="off" autocorrect="off" autocapitalize="off">
        
        <button class="btn-blue" onclick="openPwaGen()">Get PWA!</button>
    </div>

    <div id="view-preview" class="view-section">
        <h1>alwaysPWA</h1>

        <div style="height: 50px;"></div>

        <div class="image-preview-box">
            <div class="spinner" id="loading-spinner"></div>
            <div class="placeholder-text" id="placeholder-text">
                (Icon will appear here)
            </div>
            <img id="result-icon" src="" alt="Site Icon">
        </div>

        <div class="preview-text-bottom" id="result-title">
            (Site Name will appear here)
        </div>

        <button class="btn-blue" id="share-btn" onclick="triggerShare()">Share PWA!</button>
    </div>

    <iframe id="pwa-frame"></iframe>

    <script>
        // --- LOGIC ---

        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
        // Clean hash: remove the '#'
        const rawHash = window.location.hash.substring(1); 
        // Decode it in case browsers auto-encode specific chars
        const targetUrl = rawHash ? decodeURIComponent(rawHash) : "";

        const viewHome = document.getElementById('view-home');
        const viewPreview = document.getElementById('view-preview');
        const pwaFrame = document.getElementById('pwa-frame');

        // 1. ROUTING
        if (isStandalone && targetUrl) {
            // MODE: PWA (Fullscreen)
            enterPwaMode(targetUrl);
        } else if (targetUrl) {
            // MODE: PREVIEW (Setup)
            enterPreviewMode(targetUrl);
        } else {
            // MODE: HOME
            viewHome.classList.add('visible');
        }

        // --- FUNCTIONS ---

        function enterPwaMode(url) {
            // Normalize URL
            let finalUrl = url.startsWith('http') ? url : 'https://' + url;
            
            pwaFrame.src = finalUrl;
            pwaFrame.style.display = 'block';
            
            // Hide other views
            viewHome.classList.remove('visible');
            viewPreview.classList.remove('visible');

            // Fallback for X-Frame-Options blocking
            pwaFrame.onerror = function() {
                window.location.href = finalUrl;
            };
        }

        async function enterPreviewMode(url) {
            viewHome.classList.remove('visible');
            viewPreview.classList.add('visible');

            const spinner = document.getElementById('loading-spinner');
            const placeholder = document.getElementById('placeholder-text');
            const imgEl = document.getElementById('result-icon');
            const titleEl = document.getElementById('result-title');
            
            spinner.style.display = 'block';
            placeholder.style.display = 'none';

            let finalUrl = url.startsWith('http') ? url : 'https://' + url;
            let hostname = "";
            try {
                hostname = new URL(finalUrl).hostname;
            } catch (e) {
                hostname = finalUrl;
            }

            // A. SET TITLE (Default to hostname first)
            titleEl.innerText = hostname; 
            document.title = hostname;

            // B. FETCH TITLE & ICON (Robust Method)
            try {
                // 1. Fetch Title via AllOrigins (To bypass CORS)
                const titleApi = `https://api.allorigins.win/get?url=${encodeURIComponent(finalUrl)}`;
                
                // 2. Fetch Icon via Google V2 API (High Res) passed through AllOrigins (To get Base64)
                // We use Google's service because it's smarter than just looking for /favicon.ico
                const googleIconUrl = `https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${encodeURIComponent(finalUrl)}&size=256`;
                const iconProxyApi = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleIconUrl)}`;

                // Run fetches
                fetch(titleApi)
                    .then(response => response.json())
                    .then(data => {
                        if (data.contents) {
                            // Extract <title> tag using regex
                            const matches = data.contents.match(/<title>(.*?)<\/title>/i);
                            if (matches && matches[1]) {
                                const realTitle = matches[1].trim();
                                titleEl.innerText = realTitle;
                                document.title = realTitle;
                            }
                        }
                    }).catch(e => console.log("Title fetch warning:", e));

                // Process Icon
                const response = await fetch(iconProxyApi);
                if (!response.ok) throw new Error("Icon fetch failed");
                
                const blob = await response.blob();
                const reader = new FileReader();
                
                reader.onloadend = function() {
                    const base64data = reader.result;
                    
                    // Update UI
                    spinner.style.display = 'none';
                    imgEl.src = base64data;
                    imgEl.style.display = 'block';

                    // Update Apple Touch Icon Link (CRITICAL FOR PWA)
                    const linkTag = document.getElementById('dynamic-icon');
                    linkTag.href = base64data;
                }
                reader.readAsDataURL(blob);

            } catch (error) {
                console.error("Extraction failed", error);
                spinner.style.display = 'none';
                placeholder.innerText = "Icon not found";
                placeholder.style.display = 'block';
                // Even if failed, we keep the hostname as title
            }
        }

        function openPwaGen() {
            const input = document.getElementById('url-input');
            const val = input.value.trim();
            if (!val) {
                alert("Please enter a URL");
                return;
            }
            
            // Construct full URL for this page + hash
            // User requested NEW TAB for this action
            const currentPath = window.location.href.split('#')[0];
            const newUrl = currentPath + '#' + encodeURIComponent(val);
            
            window.open(newUrl, '_blank');
        }

        function triggerShare() {
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    url: window.location.href
                }).catch(console.error);
            } else {
                alert("Tap the Share button below in Safari, then select 'Add to Home Screen'.");
            }
        }
    </script>
</body>
</html>
