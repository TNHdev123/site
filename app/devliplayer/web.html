<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Devil Player</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="manifest" id="pwa-manifest">

    <style>
        :root { --accent: #ff3e3e; --bg: #000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: -apple-system, sans-serif; }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; filter: blur(30px) saturate(2.2) contrast(1.4); }
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100dvh; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        .page.active { display: flex; }
        .settings-card { background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 35px; backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); width: 80%; max-width: 280px; text-align: center; pointer-events: auto; }
        #cover { width: 65vw; max-width: 300px; aspect-ratio: 1/1; border-radius: 20px; object-fit: cover; display: none; filter: drop-shadow(0 20px 50px rgba(0,0,0,0.8)); pointer-events: auto; z-index: 11; transition: transform 0.05s linear, opacity 0.3s ease; opacity: 0; }
        #title { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); width: 80%; text-align: center; font-size: 0.9rem; font-weight: bold; color: white; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 100; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .bottom-controls { position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 480px; display: flex; align-items: center; gap: 10px; z-index: 101; }
        .play-bar { flex: 1; background: rgba(45, 45, 45, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 40px; height: 50px; display: flex; align-items: center; padding: 0 15px; pointer-events: auto; }
        .mini-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; margin-right: 10px; position: relative; }
        .mini-btn svg { width: 24px; height: 24px; fill: currentColor; }
        #seek-slider { flex: 1; accent-color: var(--accent); cursor: pointer; height: 4px; -webkit-appearance: none; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; }
        #seek-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.1); border-left-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; position: absolute; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tab-bar { position: relative; background: rgba(45, 45, 45, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 40px; padding: 5px; display: flex; gap: 5px; pointer-events: auto; }
        .tab-item { position: relative; width: 45px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: rgba(255,255,255,0.3); }
        .tab-item.active { color: var(--accent); }
        .tab-indicator { position: absolute; top: 5px; left: 5px; width: 45px; height: 40px; background: rgba(0, 0, 0, 0.5); border-radius: 20px; z-index: 1; transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.2); }
        .auto-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 0.75rem; width: 100%; margin-bottom: 8px; }
        .auto-btn.active { background: var(--accent); }
        .btn { display: block; background: var(--accent); padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 0.85rem; color: white; text-align: center; }
        .color-dot { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.active { border-color: white; transform: scale(1.1); }
        #theme-selector { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; }
        audio { display: none; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>
<div id="title">NO TRACK SELECTED</div>

<div id="page-settings" class="page active">
    <div class="settings-card">
        <button id="auto-mode" class="auto-btn active" onclick="toggleAuto()">AUTO COVER COLOR</button>
        <div id="theme-selector">
            <div class="color-dot" data-color="#ff0000" style="background:#ff0000" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#ff8c00" style="background:#ff8c00" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#00ff00" style="background:#00ff00" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#00ffff" style="background:#00ffff" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#0000ff" style="background:#0000ff" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#8a2be2" style="background:#8a2be2" onclick="selectThemeColor(this)"></div>
        </div>
        <label class="btn">SELECT MUSIC<input type="file" id="f" style="display:none"></label>
    </div>
</div>

<div id="page-play" class="page">
    <img id="cover" onclick="handlePlayPause()">
</div>

<div class="bottom-controls">
    <div class="play-bar">
        <div class="mini-btn" onclick="handlePlayPause()">
            <svg id="svg-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg id="svg-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            <div id="loading-spinner" class="spinner" style="display:none;"></div>
        </div>
        <input type="range" id="seek-slider" value="0" max="1000">
    </div>
    <div class="tab-bar">
        <div class="tab-indicator" id="indicator" style="transform: translateX(50px);"></div>
        <div class="tab-item" onclick="switchPage('play', 0)"><svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
        <div class="tab-item active" onclick="switchPage('settings', 1)"><svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.21.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div>
    </div>
</div>

<audio id="player"></audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

<script>
    const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
    const player = document.getElementById('player'), cover = document.getElementById('cover'), titleTag = document.getElementById('title');
    const sPlay = document.getElementById('svg-play'), sPause = document.getElementById('svg-pause'), spinner = document.getElementById('loading-spinner');
    const seek = document.getElementById('seek-slider'), indicator = document.getElementById('indicator'), autoBtn = document.getElementById('auto-mode');

    let aCtx, analyser, data, particles = [], albumPalette = [], selectedColors = [], isAuto = true, isSeeking = false;
    let loadTimeout;

    function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    function switchPage(p, i) {
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-item')[i].classList.add('active');
        indicator.style.transform = `translateX(${i * 50}px)`;
    }

    // 播放狀態控制：確保轉圈圈唔會卡死
    function setLoading(val) {
        if(val) {
            spinner.style.display = 'block';
            sPlay.style.display = 'none';
            sPause.style.display = 'none';
        } else {
            spinner.style.display = 'none';
            // 如果音樂正在播放，顯示暫停鍵；否則顯示播放鍵
            if(!player.paused && player.duration > 0) {
                sPlay.style.display = 'none';
                sPause.style.display = 'block';
            } else {
                sPlay.style.display = 'block';
                sPause.style.display = 'none';
            }
        }
    }

    document.getElementById('f').onchange = (e) => {
        const file = e.target.files[0]; if (!file) return;
        
        // 1. 初始化狀態
        setLoading(true);
        switchPage('play', 0);
        player.src = URL.createObjectURL(file);
        titleTag.innerText = file.name;
        cover.style.opacity = "0";

        // 2. 安全機制：500毫秒後強制解除 Loading，不管檔案係咪壞嘅
        clearTimeout(loadTimeout);
        loadTimeout = setTimeout(() => {
            setLoading(false);
        }, 500);

        // 3. 嘗試播放
        player.load();
        player.play()
            .then(() => {
                setLoading(false); // 成功播放，立即解除
            })
            .catch((err) => {
                console.log("Auto-play blocked or failed:", err);
                setLoading(false); // 失敗（例如不是音訊），也立即解除，讓用戶手動點擊
            });

        // 4. 讀取標籤（完全延遲執行，避免卡住主線程）
        setTimeout(() => {
            if(isAuto) {
                try {
                    window.jsmediatags.read(file, {
                        onSuccess: (tag) => {
                            const { picture, title: tName } = tag.tags;
                            if (tName) titleTag.innerText = tName;
                            if (picture) {
                                const { data, format } = picture;
                                let b64 = ""; for (let i = 0; i < data.length; i++) b64 += String.fromCharCode(data[i]);
                                cover.src = `data:${format};base64,${window.btoa(b64)}`;
                            }
                        },
                        onError: (e) => console.log("Tags read error:", e)
                    });
                } catch(e) { console.log(e); }
            }
        }, 100);

        if (!aCtx) initAudio();
    };

    // 額外保險：如果是非音訊檔案，onerror 會觸發
    player.onerror = () => { setLoading(false); };
    player.onpause = () => { if(spinner.style.display === 'none') { sPlay.style.display = 'block'; sPause.style.display = 'none'; } };
    player.onplay = () => { if(spinner.style.display === 'none') { sPlay.style.display = 'none'; sPause.style.display = 'block'; } };

    function handlePlayPause() { 
        // 即使有 Spinner，如果用戶點擊，強制當作播放/暫停處理，打破卡死
        if (spinner.style.display === 'block') { setLoading(false); }
        player.paused ? player.play() : player.pause(); 
    }

    seek.oninput = () => { isSeeking = true; };
    seek.onchange = () => { player.currentTime = (seek.value / 1000) * player.duration; isSeeking = false; };
    window.onkeydown = (e) => { if (e.code === 'Space') { e.preventDefault(); handlePlayPause(); } };

    function selectThemeColor(el) {
        isAuto = false; autoBtn.classList.remove('active');
        const c = el.getAttribute('data-color');
        if (el.classList.contains('active')) { el.classList.remove('active'); selectedColors = selectedColors.filter(x => x !== c); }
        else if (selectedColors.length < 5) { el.classList.add('active'); selectedColors.push(c); }
        updateParticles();
    }
    
    function toggleAuto() { 
        isAuto = true; autoBtn.classList.add('active'); 
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); 
        selectedColors = []; updateParticles(); 
    }
    
    cover.onload = () => {
        cover.style.display = 'block';
        setTimeout(() => cover.style.opacity = "1", 50);
        if (!isAuto) return;
        
        const tC = document.createElement('canvas'), tX = tC.getContext('2d');
        tC.width = tC.height = 50; tX.drawImage(cover, 0, 0, 50, 50);
        const d = tX.getImageData(0,0,50,50).data;
        albumPalette = [];
        for (let i = 0; i < 10; i++) {
            let idx = Math.floor(Math.random() * (d.length / 4)) * 4;
            albumPalette.push(`rgb(${d[idx]},${d[idx+1]},${d[idx+2]})`);
        }
        updateParticles();
    };

    function updateParticles() {
        const cX = cvs.width/2, cY = cvs.height/2;
        const pal = (isAuto || !selectedColors.length) ? (albumPalette.length ? albumPalette : ['#444']) : selectedColors;
        particles = pal.map(c => ({ x:cX, y:cY, angle:Math.random()*Math.PI*2, distance:0, baseSize:Math.random()*40+60, color:c, speed:0.005+Math.random()*0.01 }));
    }

    function initAudio() {
        try {
            aCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = aCtx.createAnalyser(); 
            const s = aCtx.createMediaElementSource(player);
            s.connect(analyser); analyser.connect(aCtx.destination);
            analyser.fftSize = 256; data = new Uint8Array(analyser.frequencyBinCount);
            loop();
        } catch(e) { console.log("Audio Init Failed", e); }
    }

    function loop() {
        requestAnimationFrame(loop);
        if (!isSeeking && player.duration) seek.value = (player.currentTime / player.duration) * 1000;
        let b = 0, m = 0;
        if (analyser && !player.paused) { analyser.getByteFrequencyData(data); b = data[2]; m = data[15]; }
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        ctx.globalCompositeOperation = 'screen';
        particles.forEach((p, i) => {
            let e = (i % 2 === 0) ? b : m;
            p.angle += p.speed + (e / 1500);
            p.distance += ((e / 255) * (Math.min(cvs.width, cvs.height)*0.25) - p.distance) * 0.15;
            let x = (cvs.width/2) + Math.cos(p.angle) * p.distance, y = (cvs.height/2) + Math.sin(p.angle) * p.distance;
            let sz = p.baseSize + (e * 0.6);
            const g = ctx.createRadialGradient(x, y, 0, x, y, sz);
            g.addColorStop(0, p.color); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, sz, 0, Math.PI*2); ctx.fill();
        });
        if (cover.style.display === 'block') cover.style.transform = `scale(${1 + (b / 600)})`;
    }
    window.onclick = () => { if(aCtx) aCtx.resume(); };
</script>
</body>
</html>
