<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Devil Player</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Devil Player">
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="manifest" id="pwa-manifest">

    <style>
        :root { --accent: #ff3e3e; --bg: #000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; filter: blur(30px) saturate(2.2) contrast(1.4); }
        
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100dvh; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        .page.active { display: flex; }
        .card { background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 35px; backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); width: 80%; max-width: 280px; text-align: center; pointer-events: auto; }
        
        /* Play Page */
        .cover-wrapper { position: relative; width: 160px; height: 160px; margin: 0 auto 15px; cursor: pointer; }
        #cover { width: 100%; height: 100%; border-radius: 20px; object-fit: cover; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Loading Spinner */
        .spinner { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--accent);
            border-radius: 50%; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        #title { margin-bottom: 20px; font-size: 0.85rem; font-weight: bold; color: white; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Settings */
        .setting-title { font-size: 0.9rem; font-weight: bold; margin-bottom: 15px; color: white; letter-spacing: 1px; }
        #theme-selector { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot.active { border-color: white; transform: scale(1.15); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .auto-btn, .cache-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 14px; border-radius: 12px; cursor: pointer; font-size: 0.75rem; margin-bottom: 10px; width: 100%; }
        .auto-btn.active { background: var(--accent); border-color: var(--accent); }
        .btn { display: block; background: var(--accent); padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 0.85rem; color: white; margin-top: 5px; }

        /* Smooth Bottom Controls */
        .bottom-controls { position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; display: flex; align-items: center; gap: 12px; z-index: 100; }
        .progress-container { flex: 1; background: rgba(45, 45, 45, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 40px; height: 50px; display: flex; align-items: center; padding: 0 18px; pointer-events: auto; }
        #seek-slider { width: 100%; accent-color: var(--accent); cursor: pointer; height: 6px; -webkit-appearance: none; background: rgba(255,255,255,0.1); border-radius: 3px; outline: none; }
        #seek-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; }

        .tab-bar { position: relative; background: rgba(45, 45, 45, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 40px; padding: 5px; display: flex; gap: 5px; pointer-events: auto; }
        .tab-item { position: relative; width: 45px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; transition: color 0.3s; color: rgba(255,255,255,0.3); }
        .tab-item.active { color: var(--accent); }
        .tab-item svg { width: 22px; height: 22px; fill: currentColor; }
        .tab-indicator { position: absolute; top: 5px; left: 5px; width: 45px; height: 40px; background: rgba(0, 0, 0, 0.5); border-radius: 20px; z-index: 1; transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.2); }
        
        audio { display: none; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="page-settings" class="page active">
    <div class="card">
        <div class="setting-title">VISUALS</div>
        <button id="auto-mode" class="auto-btn active" onclick="toggleAuto()">AUTO COVER COLOR</button>
        <div id="theme-selector">
            <div class="color-dot" data-color="#ff0000" style="background:#ff0000" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#ff8c00" style="background:#ff8c00" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#ffff00" style="background:#ffff00" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#00ff00" style="background:#00ff00" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#00ffff" style="background:#00ffff" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#0000ff" style="background:#0000ff" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#4b0082" style="background:#4b0082" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#8a2be2" style="background:#8a2be2" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#8b4513" style="background:#8b4513" onclick="selectThemeColor(this)"></div>
            <div class="color-dot" data-color="#808080" style="background:#808080" onclick="selectThemeColor(this)"></div>
        </div>
        <label class="btn">
            SELECT MUSIC
            <input type="file" id="f" accept="audio/*" style="display:none">
        </label>
        <button class="cache-btn" style="margin-top: 15px;" onclick="clearAppCache()">CLEAR APP DATA</button>
    </div>
</div>

<div id="page-play" class="page">
    <div class="card">
        <div class="cover-wrapper" onclick="handlePlayPause()">
            <div id="loader" class="spinner"></div>
            <img id="cover">
        </div>
        <div id="title">READY TO PLAY</div>
        <div id="play-hint" style="color: white; font-size: 0.65rem; opacity: 0.4; letter-spacing: 1px;">TAP COVER TO TOGGLE</div>
    </div>
</div>

<div class="bottom-controls">
    <div class="progress-container">
        <input type="range" id="seek-slider" value="0" max="1000">
    </div>
    <div class="tab-bar">
        <div class="tab-indicator" id="indicator" style="transform: translateX(50px);"></div>
        <div class="tab-item" onclick="switchPage('play', 0)">
            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
        </div>
        <div class="tab-item active" onclick="switchPage('settings', 1)">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.21.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </div>
    </div>
</div>

<audio id="player" crossorigin="anonymous"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

<script>
    // --- PWA Service Worker ---
    const swCode = `
        const CACHE_NAME = 'devil-player-v1';
        self.addEventListener('install', e => {
            e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./', './index.html', './icon.png'])));
        });
        self.addEventListener('fetch', e => {
            e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
        });
    `;
    const blob = new Blob([swCode], {type: 'application/javascript'});
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(URL.createObjectURL(blob));
    }

    // --- Manifest Generation ---
    const manifest = {
        name: "Devil Player", short_name: "Devil Player", start_url: "./",
        display: "standalone", background_color: "#000000", theme_color: "#ff3e3e",
        icons: [{ src: "./icon.png", sizes: "512x512", type: "image/png" }]
    };
    document.getElementById('pwa-manifest').setAttribute('href', 'data:application/json;base64,' + btoa(JSON.stringify(manifest)));

    // --- Core Logic ---
    const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
    const player = document.getElementById('player'), cover = document.getElementById('cover'), loader = document.getElementById('loader');
    const titleDisp = document.getElementById('title'), indicator = document.getElementById('indicator');
    const autoBtn = document.getElementById('auto-mode'), seekSlider = document.getElementById('seek-slider');

    let aCtx, analyser, data, particles = [], albumPalette = [], selectedColors = [], isAuto = true, isSeeking = false;

    function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    function switchPage(pageName, index) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-item')[index].classList.add('active');
        indicator.style.transform = `translateX(${index * 50}px)`;
    }

    document.getElementById('f').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Show Loading
        loader.style.display = 'block';
        cover.style.display = 'none';
        
        player.src = URL.createObjectURL(file);
        titleDisp.innerText = file.name;

        window.jsmediatags.read(file, {
            onSuccess: (tag) => {
                const { picture, title } = tag.tags;
                if (title) titleDisp.innerText = title;
                if (picture) {
                    const { data, format } = picture;
                    let b64 = "";
                    for (let i = 0; i < data.length; i++) b64 += String.fromCharCode(data[i]);
                    cover.src = `data:${format};base64,${window.btoa(b64)}`;
                }
            }
        });
        if (!aCtx) initAudio();
    };

    player.oncanplay = () => {
        loader.style.display = 'none';
        cover.style.display = 'block';
        if(document.getElementById('page-settings').classList.contains('active')) {
            switchPage('play', 0);
        }
        player.play().catch(() => {}); 
    };

    // Smooth Seek Logic
    seekSlider.oninput = () => { isSeeking = true; };
    seekSlider.onchange = () => {
        player.currentTime = (seekSlider.value / 1000) * player.duration;
        isSeeking = false;
    };

    function handlePlayPause() {
        if (loader.style.display === 'block') return;
        player.paused ? player.play() : player.pause();
    }

    function selectThemeColor(el) {
        isAuto = false; autoBtn.classList.remove('active');
        const color = el.getAttribute('data-color');
        if (el.classList.contains('active')) {
            el.classList.remove('active');
            selectedColors = selectedColors.filter(c => c !== color);
        } else if (selectedColors.length < 5) {
            el.classList.add('active');
            selectedColors.push(color);
        }
        updateParticles();
    }

    function toggleAuto() {
        isAuto = true; autoBtn.classList.add('active');
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
        selectedColors = [];
        updateParticles();
    }

    cover.onload = () => {
        const tC = document.createElement('canvas'), tX = tC.getContext('2d');
        tC.width = 10; tC.height = 10; tX.drawImage(cover, 0, 0, 10, 10);
        const d = tX.getImageData(0, 0, 10, 10).data;
        albumPalette = [];
        for (let i = 0; i < d.length; i += 4) albumPalette.push(`rgb(${d[i]},${d[i+1]},${d[i+2]})`);
        if(isAuto) updateParticles();
    };

    function updateParticles() {
        const cX = cvs.width / 2, cY = cvs.height / 2;
        const targetPalette = (isAuto || selectedColors.length === 0) ? albumPalette : selectedColors;
        if (targetPalette.length === 0) return;
        particles = targetPalette.map((col, i) => ({
            x: cX, y: cY, angle: Math.random() * Math.PI * 2, distance: 0,
            baseSize: Math.random() * 40 + 60, color: col, speed: 0.005 + Math.random() * 0.01
        }));
    }

    function initAudio() {
        aCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = aCtx.createAnalyser();
        const s = aCtx.createMediaElementSource(player);
        s.connect(analyser); analyser.connect(aCtx.destination);
        analyser.fftSize = 256; data = new Uint8Array(analyser.frequencyBinCount);
        loop();
    }

    function loop() {
        requestAnimationFrame(loop);
        
        // Update Progress Bar Smoothly
        if (!isSeeking && !isNaN(player.duration)) {
            seekSlider.value = (player.currentTime / player.duration) * 1000;
        }

        let bass = 0, mid = 0;
        if (analyser && !player.paused) {
            analyser.getByteFrequencyData(data);
            bass = data[2]; mid = data[15];
        }
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        ctx.globalCompositeOperation = 'screen';
        particles.forEach((p, i) => {
            let energy = (i % 2 === 0) ? bass : mid;
            p.angle += p.speed + (energy / 1500);
            let maxTravel = Math.min(cvs.width, cvs.height) * 0.25;
            p.distance += ((energy / 255) * maxTravel - p.distance) * 0.15;
            let x = (cvs.width/2) + Math.cos(p.angle) * p.distance;
            let y = (cvs.height/2) + Math.sin(p.angle) * p.distance;
            let dynamicSize = p.baseSize + (energy * 0.6);
            const g = ctx.createRadialGradient(x, y, 0, x, y, dynamicSize);
            g.addColorStop(0, p.color); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, dynamicSize, 0, Math.PI * 2); ctx.fill();
        });
        if (cover.style.display === 'block') {
            cover.style.transform = `scale(${1 + (bass / 1200)})`;
        }
    }

    async function clearAppCache() {
        if ('caches' in window) {
            const names = await caches.keys();
            await Promise.all(names.map(name => caches.delete(name)));
            alert("App cache cleared. Please reload.");
            location.reload();
        }
    }

    window.onclick = () => { if(aCtx) aCtx.resume(); };
</script>
</body>
</html>

