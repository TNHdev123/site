<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Devil Player</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Devil Player">
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="manifest" id="pwa-manifest">

    <style>
        :root { --accent: #ff3e3e; --bg: #000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: -apple-system, sans-serif; }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; filter: blur(30px) saturate(2.2) contrast(1.4); }
        
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100dvh; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        .page.active { display: flex; }
        .card { background: rgba(0, 0, 0, 0.7); padding: 30px; border-radius: 35px; backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); width: 80%; max-width: 280px; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        
        /* 封面置中 */
        #cover { width: 220px; height: 220px; border-radius: 20px; object-fit: cover; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: pointer; }

        /* Settings */
        .setting-content { width: 100%; text-align: center; }
        .setting-title { font-size: 0.9rem; font-weight: bold; margin-bottom: 15px; color: white; }
        #theme-selector { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.active { border-color: white; transform: scale(1.15); }
        .auto-btn, .cache-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 0.75rem; width: 100%; margin-bottom: 8px; }
        .auto-btn.active { background: var(--accent); border-color: var(--accent); }
        .btn { display: block; background: var(--accent); padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 0.85rem; color: white; text-transform: uppercase; }

        /* 底部控制區域 */
        .controls-wrapper { position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 480px; z-index: 100; }
        
        /* 標題放在 Tab 上方 */
        #title { width: 100%; text-align: center; font-size: 0.8rem; font-weight: bold; color: white; opacity: 0.9; margin-bottom: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        .bottom-row { display: flex; align-items: center; gap: 10px; }
        .play-bar { flex: 1; background: rgba(45, 45, 45, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 40px; height: 50px; display: flex; align-items: center; padding: 0 15px; pointer-events: auto; }
        .mini-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; margin-right: 10px; position: relative; }
        .mini-btn svg { width: 24px; height: 24px; fill: currentColor; }
        #seek-slider { flex: 1; accent-color: var(--accent); cursor: pointer; height: 4px; -webkit-appearance: none; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; }
        #seek-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; }

        /* Spinner */
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.1); border-left-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; position: absolute; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Tabs */
        .tab-bar { position: relative; background: rgba(45, 45, 45, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 40px; padding: 5px; display: flex; gap: 5px; pointer-events: auto; }
        .tab-item { position: relative; width: 45px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: rgba(255,255,255,0.3); }
        .tab-item.active { color: var(--accent); }
        .tab-indicator { position: absolute; top: 5px; left: 5px; width: 45px; height: 40px; background: rgba(0, 0, 0, 0.5); border-radius: 20px; z-index: 1; transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.2); }
        
        audio { display: none; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="page-settings" class="page active">
    <div class="card">
        <div class="setting-content">
            <div class="setting-title">VISUAL SETTINGS</div>
            <button id="auto-mode" class="auto-btn active" onclick="toggleAuto()">AUTO COVER COLOR</button>
            <div id="theme-selector">
                <div class="color-dot" data-color="#ff0000" style="background:#ff0000" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#ff8c00" style="background:#ff8c00" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#ffff00" style="background:#ffff00" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#00ff00" style="background:#00ff00" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#00ffff" style="background:#00ffff" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#0000ff" style="background:#0000ff" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#4b0082" style="background:#4b0082" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#8a2be2" style="background:#8a2be2" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#8b4513" style="background:#8b4513" onclick="selectThemeColor(this)"></div>
                <div class="color-dot" data-color="#808080" style="background:#808080" onclick="selectThemeColor(this)"></div>
            </div>
            <label class="btn">
                SELECT MUSIC
                <input type="file" id="f" style="display:none">
            </label>
            <button class="cache-btn" style="margin-top: 15px;" onclick="clearAppCache()">CLEAR APP DATA</button>
        </div>
    </div>
</div>

<div id="page-play" class="page">
    <div class="card">
        <img id="cover" onclick="handlePlayPause()">
    </div>
</div>

<div class="controls-wrapper">
    <div id="title">READY TO PLAY</div>
    
    <div class="bottom-row">
        <div class="play-bar">
            <div class="mini-btn" onclick="handlePlayPause()">
                <svg id="svg-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg id="svg-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                <div id="loading-spinner" class="spinner" style="display:none;"></div>
            </div>
            <input type="range" id="seek-slider" value="0" max="1000">
        </div>
        <div class="tab-bar">
            <div class="tab-indicator" id="indicator" style="transform: translateX(50px);"></div>
            <div class="tab-item" onclick="switchPage('play', 0)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <div class="tab-item active" onclick="switchPage('settings', 1)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.21.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </div>
        </div>
    </div>
</div>

<audio id="player" crossorigin="anonymous"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

<script>
    const swCode = `const C='dp-vfinal-4';self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(['./','./index.html','./icon.png']))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
    const blob = new Blob([swCode], {type: 'application/javascript'});
    if ('serviceWorker' in navigator) navigator.serviceWorker.register(URL.createObjectURL(blob));
    const manifest = { name: "Devil Player", short_name: "Devil Player", start_url: "./", display: "standalone", background_color: "#000", theme_color: "#ff3e3e", icons: [{ src: "./icon.png", sizes: "512x512", type: "image/png" }] };
    document.getElementById('pwa-manifest').setAttribute('href', 'data:application/json;base64,' + btoa(JSON.stringify(manifest)));

    const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
    const player = document.getElementById('player'), cover = document.getElementById('cover');
    const sPlay = document.getElementById('svg-play'), sPause = document.getElementById('svg-pause'), spinner = document.getElementById('loading-spinner');
    const seek = document.getElementById('seek-slider'), indicator = document.getElementById('indicator'), autoBtn = document.getElementById('auto-mode');

    let aCtx, analyser, data, particles = [], albumPalette = [], selectedColors = [], isAuto = true, isSeeking = false;

    function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    function switchPage(p, i) {
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-item')[i].classList.add('active');
        indicator.style.transform = `translateX(${i * 50}px)`;
    }

    document.getElementById('f').onchange = (e) => {
        const file = e.target.files[0]; if (!file) return;
        setLoading(true);
        switchPage('play', 0);
        
        const url = URL.createObjectURL(file);
        player.src = url;
        document.getElementById('title').innerText = file.name;
        
        // 異步讀取標籤，不阻塞播放
        window.jsmediatags.read(file, {
            onSuccess: (tag) => {
                const { picture, title } = tag.tags;
                if (title) document.getElementById('title').innerText = title;
                if (picture) {
                    const { data, format } = picture;
                    let b64 = ""; for (let i = 0; i < data.length; i++) b64 += String.fromCharCode(data[i]);
                    cover.src = `data:${format};base64,${window.btoa(b64)}`;
                }
            },
            onError: () => { console.log("No tags found"); }
        });

        if (!aCtx) initAudio();
    };

    function setLoading(val) {
        spinner.style.display = val ? 'block' : 'none';
        sPlay.style.display = val ? 'none' : (player.paused ? 'block' : 'none');
        sPause.style.display = val ? 'none' : (player.paused ? 'none' : 'block');
    }

    // 當數據開始加載就取消轉圈，提升反應速度
    player.onplay = () => { setLoading(false); sPlay.style.display = 'none'; sPause.style.display = 'block'; };
    player.onplaying = () => setLoading(false);
    player.onpause = () => { sPlay.style.display = 'block'; sPause.style.display = 'none'; };
    player.oncanplay = () => { player.play().catch(()=>{}); };

    function handlePlayPause() { if (spinner.style.display === 'block' && !player.src) return; player.paused ? player.play() : player.pause(); }

    seek.oninput = () => { isSeeking = true; };
    seek.onchange = () => { player.currentTime = (seek.value / 1000) * player.duration; isSeeking = false; };

    window.onkeydown = (e) => { if (e.code === 'Space') { e.preventDefault(); handlePlayPause(); } };

    function selectThemeColor(el) {
        isAuto = false; autoBtn.classList.remove('active');
        const c = el.getAttribute('data-color');
        if (el.classList.contains('active')) { el.classList.remove('active'); selectedColors = selectedColors.filter(x => x !== c); }
        else if (selectedColors.length < 5) { el.classList.add('active'); selectedColors.push(c); }
        updateParticles();
    }
    function toggleAuto() { isAuto = true; autoBtn.classList.add('active'); document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); selectedColors = []; updateParticles(); }
    
    cover.onload = () => {
        cover.style.display = 'block';
        const tC = document.createElement('canvas'), tX = tC.getContext('2d');
        tC.width = tC.height = 10; tX.drawImage(cover, 0, 0, 10, 10);
        const d = tX.getImageData(0,0,10,10).data; albumPalette = [];
        for (let i = 0; i < d.length; i += 4) albumPalette.push(`rgb(${d[i]},${d[i+1]},${d[i+2]})`);
        if(isAuto) updateParticles();
    };

    function updateParticles() {
        const cX = cvs.width/2, cY = cvs.height/2;
        const pal = (isAuto || !selectedColors.length) ? albumPalette : selectedColors;
        if (!pal.length) return;
        particles = pal.map(c => ({ x:cX, y:cY, angle:Math.random()*Math.PI*2, distance:0, baseSize:Math.random()*40+60, color:c, speed:0.005+Math.random()*0.01 }));
    }

    function initAudio() {
        aCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = aCtx.createAnalyser(); 
        const s = aCtx.createMediaElementSource(player);
        s.connect(analyser); analyser.connect(aCtx.destination);
        analyser.fftSize = 256; data = new Uint8Array(analyser.frequencyBinCount);
        loop();
    }

    function loop() {
        requestAnimationFrame(loop);
        if (!isSeeking && player.duration) seek.value = (player.currentTime / player.duration) * 1000;
        let b = 0, m = 0;
        if (analyser && !player.paused) { analyser.getByteFrequencyData(data); b = data[2]; m = data[15]; }
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        ctx.globalCompositeOperation = 'screen';
        particles.forEach((p, i) => {
            let e = (i % 2 === 0) ? b : m;
            p.angle += p.speed + (e / 1500);
            p.distance += ((e / 255) * (Math.min(cvs.width, cvs.height)*0.25) - p.distance) * 0.15;
            let x = (cvs.width/2) + Math.cos(p.angle) * p.distance, y = (cvs.height/2) + Math.sin(p.angle) * p.distance;
            let sz = p.baseSize + (e * 0.6);
            const g = ctx.createRadialGradient(x, y, 0, x, y, sz);
            g.addColorStop(0, p.color); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, sz, 0, Math.PI*2); ctx.fill();
        });
        if (cover.style.display === 'block') cover.style.transform = `scale(${1 + (b / 1200)})`;
    }

    async function clearAppCache() { 
        if ('caches' in window) { 
            const ns = await caches.keys(); 
            await Promise.all(ns.map(n => caches.delete(n))); 
            alert("App cache cleared. Reloading...");
            location.reload(); 
        } 
    }
    window.onclick = () => { if(aCtx) aCtx.resume(); };
</script>
</body>
</html>
