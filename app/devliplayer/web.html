<script>
    const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
    const player = document.getElementById('player'), cover = document.getElementById('cover'), titleTag = document.getElementById('title');
    const sPlay = document.getElementById('svg-play'), sPause = document.getElementById('svg-pause'), spinner = document.getElementById('loading-spinner');
    const seek = document.getElementById('seek-slider'), indicator = document.getElementById('indicator');
    let aCtx, analyser, data, particles = [], albumPalette = [], selectedColors = [], isAuto = true, isSeeking = false, showCover = true, db;

    const dbReq = indexedDB.open("devilLatestDB", 1);
    dbReq.onupgradeneeded = (e) => { e.target.result.createObjectStore("devilLatest"); };
    dbReq.onsuccess = (e) => { db = e.target.result; loadAppState(); };

    function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    function switchPage(p, i) {
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-item')[i].classList.add('active');
        indicator.style.transform = `translateX(${i * 50}px)`;
    }

    function saveSettings() {
        localStorage.setItem('devilSettings', JSON.stringify({ loop: player.loop, showCover, isAuto, selectedColors }));
    }

    function loadAppState() {
        const s = JSON.parse(localStorage.getItem('devilSettings'));
        if (s) {
            player.loop = s.loop ?? true; showCover = s.showCover ?? true; isAuto = s.isAuto ?? true; selectedColors = s.selectedColors || [];
            document.getElementById('opt-loop').classList.toggle('active', player.loop);
            document.getElementById('loop-status').innerText = player.loop ? "ON" : "OFF";
            document.getElementById('opt-cover').classList.toggle('active', showCover);
            document.getElementById('cover-status').innerText = showCover ? "ON" : "OFF";
            document.getElementById('opt-auto').classList.toggle('active', isAuto);
            document.getElementById('auto-status').innerText = isAuto ? "ON" : "OFF";
            if (!isAuto) document.querySelectorAll('.color-dot').forEach(d => { if (selectedColors.includes(d.getAttribute('data-color'))) d.classList.add('active'); });
        } else { player.loop = true; }

        const tx = db.transaction("devilLatest", "readonly");
        const req = tx.objectStore("devilLatest").get("latestTrack");
        req.onsuccess = () => {
            if (req.result) {
                const fileBlob = req.result.blob;
                player.src = URL.createObjectURL(fileBlob);
                titleTag.innerText = req.result.name;
                processFileMetadata(fileBlob);
                switchPage('play', 0);
            }
        };
        updateParticles();
    }

    function updateBackgroundInfo(title, art) {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: title || titleTag.innerText,
                artist: 'Devil Player',
                artwork: art ? [{ src: art, sizes: '512x512', type: 'image/png' }] : []
            });
            navigator.mediaSession.setActionHandler('play', () => player.play());
            navigator.mediaSession.setActionHandler('pause', () => player.pause());
            navigator.mediaSession.setActionHandler('seekbackward', (details) => { player.currentTime = Math.max(player.currentTime - (details.seekOffset || 10), 0); });
            navigator.mediaSession.setActionHandler('seekforward', (details) => { player.currentTime = Math.min(player.currentTime + (details.seekOffset || 10), player.duration); });
        }
    }

    function toggleLoop() { player.loop = !player.loop; document.getElementById('opt-loop').classList.toggle('active', player.loop); document.getElementById('loop-status').innerText = player.loop ? "ON" : "OFF"; saveSettings(); }
    function toggleCoverVisible() { showCover = !showCover; document.getElementById('opt-cover').classList.toggle('active', showCover); document.getElementById('cover-status').innerText = showCover ? "ON" : "OFF"; cover.style.display = (showCover && cover.src) ? 'block' : 'none'; saveSettings(); }
    function toggleAuto() { isAuto = !isAuto; document.getElementById('opt-auto').classList.toggle('active', isAuto); document.getElementById('auto-status').innerText = isAuto ? "ON" : "OFF"; if (isAuto) { document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); selectedColors = []; } updateParticles(); saveSettings(); }

    function setLoading(val) {
        spinner.style.display = val ? 'block' : 'none';
        if(!val) { sPlay.style.display = player.paused ? 'block' : 'none'; sPause.style.display = player.paused ? 'none' : 'block'; }
        else { sPlay.style.display = 'none'; sPause.style.display = 'none'; }
    }

    document.getElementById('f').onchange = (e) => {
        const file = e.target.files[0]; if (!file) return;
        setLoading(true); switchPage('play', 0);
        if (player.src) URL.revokeObjectURL(player.src);
        player.src = URL.createObjectURL(file);
        titleTag.innerText = file.name; cover.style.opacity = "0";
        const tx = db.transaction("devilLatest", "readwrite");
        tx.objectStore("devilLatest").put({ name: file.name, blob: file }, "latestTrack");
        player.load(); player.play().then(() => { setLoading(false); }).catch(() => setLoading(false));
        processFileMetadata(file);
    };

    function processFileMetadata(file) {
        window.jsmediatags.read(file, {
            onSuccess: (tag) => {
                const { picture, title: tName } = tag.tags;
                const finalTitle = tName || (file.name ? file.name.replace(/\.[^/.]+$/, "") : "Unknown");
                titleTag.innerText = finalTitle;
                let finalArt = null;
                if (picture) {
                    const { data, format } = picture;
                    let b64 = ""; for (let i = 0; i < data.length; i++) b64 += String.fromCharCode(data[i]);
                    finalArt = `data:${format};base64,${window.btoa(b64)}`;
                    cover.src = finalArt;
                }
                updateBackgroundInfo(finalTitle, finalArt);
            },
            onError: () => updateBackgroundInfo(titleTag.innerText, null)
        });
    }

    // 關鍵修復：分離 AudioContext 的狀態與播放器的狀態
    player.onpause = () => { 
        sPlay.style.display = 'block'; 
        sPause.style.display = 'none'; 
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused"; 
    };

    player.onplay = () => { 
        sPlay.style.display = 'none'; 
        sPause.style.display = 'block'; 
        // 確保進入動畫，但不阻塞背景播放
        if (aCtx) { if (aCtx.state === 'suspended') aCtx.resume(); } else { initAudio(); }
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing"; 
    };

    function handlePlayPause() { 
        if (!player.src) return;
        if (player.paused) { player.play(); } else { player.pause(); } 
    }

    function selectThemeColor(el) {
        if (isAuto) toggleAuto();
        const c = el.getAttribute('data-color');
        if (el.classList.contains('active')) { el.classList.remove('active'); selectedColors = selectedColors.filter(x => x !== c); }
        else if (selectedColors.length < 13) { el.classList.add('active'); selectedColors.push(c); }
        updateParticles(); saveSettings();
    }
    
    cover.onload = () => {
        if (showCover) cover.style.display = 'block';
        setTimeout(() => cover.style.opacity = "1", 50);
        if (!isAuto) return;
        const tC = document.createElement('canvas'), tX = tC.getContext('2d'); tC.width = tC.height = 50; tX.drawImage(cover, 0, 0, 50, 50);
        const d = tX.getImageData(0,0,50,50).data; albumPalette = [];
        for (let i = 0; i < 10; i++) { let idx = Math.floor(Math.random() * (d.length / 4)) * 4; albumPalette.push(`rgb(${d[idx]},${d[idx+1]},${d[idx+2]})`); }
        updateParticles();
    };

    function updateParticles() {
        const cX = cvs.width/2, cY = cvs.height/2;
        const pal = (!isAuto && selectedColors.length) ? selectedColors : (albumPalette.length ? albumPalette : ['#444']);
        particles = pal.map(c => ({ x:cX, y:cY, angle:Math.random()*Math.PI*2, distance:0, baseSize:Math.random()*40+60, color:c, speed:0.005+Math.random()*0.01 }));
    }

    function initAudio() {
        if (aCtx) return;
        try {
            aCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = aCtx.createAnalyser(); 
            const s = aCtx.createMediaElementSource(player);
            s.connect(analyser); 
            analyser.connect(aCtx.destination);
            analyser.fftSize = 256; 
            data = new Uint8Array(analyser.frequencyBinCount);
            loop();
        } catch(e) { console.log("Init Audio blocked"); }
    }

    function loop() {
        requestAnimationFrame(loop);
        if (!isSeeking && player.duration && !player.paused) seek.value = (player.currentTime / player.duration) * 1000;
        let b = 0, m = 0;
        // 只有在前台且 aCtx 運行時才更新頻譜數據
        if (analyser && !player.paused && aCtx && aCtx.state === 'running') { 
            analyser.getByteFrequencyData(data); 
            b = data[2]; 
            m = data[15]; 
        }
        ctx.clearRect(0, 0, cvs.width, cvs.height); 
        ctx.globalCompositeOperation = 'screen';
        particles.forEach((p, i) => {
            let e = (i % 2 === 0) ? b : m; p.angle += p.speed + (e / 1500);
            p.distance += ((e / 255) * (Math.min(cvs.width, cvs.height)*0.25) - p.distance) * 0.15;
            let x = (cvs.width/2) + Math.cos(p.angle) * p.distance, y = (cvs.height/2) + Math.sin(p.angle) * p.distance;
            let sz = p.baseSize + (e * 0.6); 
            const g = ctx.createRadialGradient(x, y, 0, x, y, sz);
            g.addColorStop(0, p.color); g.addColorStop(1, 'transparent'); 
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, sz, 0, Math.PI*2); ctx.fill();
        });
        if (showCover && cover.style.display === 'block') cover.style.transform = `scale(${1 + (b / 600)})`;
    }

    async function clearAppCache() { 
        if (confirm('Clear all settings, music and cache?')) { 
            localStorage.clear(); indexedDB.deleteDatabase("devilLatestDB");
            if ('caches' in window) { const ns = await caches.keys(); await Promise.all(ns.map(n => caches.delete(n))); }
            location.reload(); 
        } 
    }
    
    seek.oninput = () => { isSeeking = true; };
    seek.onchange = () => { if(player.duration) player.currentTime = (seek.value / 1000) * player.duration; isSeeking = false; };
</script>
