<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaverLoop</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
            overflow: hidden;
            color: white;
            font-family: sans-serif;
            font-size: 1em;
            text-align: center;
        }
        #message-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        #message {
            margin-bottom: 20px;
        }
        #version {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8em;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="message-container">
        <div id="message">SaverLoop will start in 5s or by tapping the screen</div>
    </div>
    <div id="version">version: Internal_α0.1</div>
    <video id="myVideo" src="https://archive.org/download/iphone_portrait_202402/iPad_Portrait.m4v" playsinline loop></video>

    <script>
        const videoElement = document.getElementById('myVideo');
        const messageContainer = document.getElementById('message-container');
        const messageElement = document.getElementById('message');
        const redirectUrl = "https://www.apple.com";
        let motionPermissionGranted = false;
        let isPlaying = false;
        let countdown = 5;
        let countdownTimer;

        function startVideoAndMotionDetection() {
            if (isPlaying) return;
            isPlaying = true;
            
            messageContainer.style.display = 'none';

            videoElement.play().then(() => {
                if (videoElement.requestFullscreen) {
                    videoElement.requestFullscreen();
                } else if (videoElement.webkitEnterFullscreen) {
                    videoElement.webkitEnterFullscreen();
                }

                let motionDetected = false;
                const threshold = 1.0;

                window.addEventListener('devicemotion', event => {
                    const acceleration = event.accelerationIncludingGravity;
                    if (Math.abs(acceleration.x) > threshold || Math.abs(acceleration.y) > threshold || Math.abs(acceleration.z) > threshold) {
                        if (isPlaying && !motionDetected) {
                            motionDetected = true;
                            // 在此直接導向，不經過暫停事件
                            if (redirectUrl) {
                                window.location.href = redirectUrl;
                            }
                        }
                    }
                });
            }).catch(e => {
                console.error("影片播放失敗: ", e);
                messageContainer.style.display = 'block';
                messageElement.textContent = "播放失敗，請再試一次。";
                isPlaying = false;
            });
        }

        function handleStart() {
            if (!motionPermissionGranted) {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(permissionState => {
                        if (permissionState === 'granted') {
                            motionPermissionGranted = true;
                            startVideoAndMotionDetection();
                        } else {
                            messageElement.textContent = "需要動作權限才能啟動，請再試一次。";
                        }
                    }).catch(console.error);
                } else {
                    motionPermissionGranted = true;
                    startVideoAndMotionDetection();
                }
            }
        }

        // 處理點擊事件
        document.body.addEventListener('click', () => {
            if (!isPlaying) {
                clearInterval(countdownTimer);
                handleStart();
            }
        });

        // 倒數計時邏輯
        function updateCountdown() {
            messageElement.textContent = `SaverLoop will start in ${countdown}s or by tapping the screen`;
            countdown--;
            if (countdown < 0) {
                clearInterval(countdownTimer);
                messageElement.textContent = "Tap the screen to start";
            }
        }
        countdownTimer = setInterval(updateCountdown, 1000);

    </script>
</body>
</html>
